load("units.zen", "Voltage")
load("interfaces.zen", "Power")

Severity = enum("error", "warning", "advice")


def voltage_within(
    within: str | Voltage, name: str = "voltage_check", severity: Severity = Severity("error")
) -> typing.Callable:
    def ensure_voltage_within(_module, net_name: str, voltage: Voltage, within: str | Voltage):
        within = Voltage(within)
        # drop nominal in within:
        within = Voltage(min=within.min, max=within.max)
        # ensure voltage is within within
        err_msg = "Voltage range " + str(voltage) + " of " + net_name + " is not within " + str(within)
        check(voltage in within, err_msg)

    def check_gen(power: Power, severity: Severity = severity, name: str = name):
        check_name = power.NET.name + "_" + name
        if not hasattr(power, "voltage"):
            return
        builtin.add_electrical_check(
            name=check_name,
            check_fn=ensure_voltage_within,
            inputs={"voltage": power.voltage, "within": within, "net_name": power.NET.name},
            severity=severity.value,
        )

    return check_gen
