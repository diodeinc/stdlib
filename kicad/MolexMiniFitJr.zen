load("../properties.zen", "Properties")

# -----------------------------------------------------------------------------
# Component types
# -----------------------------------------------------------------------------

Variant = enum(
    # Vertical variants
    "5566-02A_2x01_P4.20mm_Vertical",
    "5566-04A_2x02_P4.20mm_Vertical",
    "5566-06A_2x03_P4.20mm_Vertical",
    "5566-08A_2x04_P4.20mm_Vertical",
    "5566-10A_2x05_P4.20mm_Vertical",
    "5566-12A_2x06_P4.20mm_Vertical",
    "5566-14A_2x07_P4.20mm_Vertical",
    "5566-16A_2x08_P4.20mm_Vertical",
    "5566-18A_2x09_P4.20mm_Vertical",
    "5566-20A_2x10_P4.20mm_Vertical",
    "5566-22A_2x11_P4.20mm_Vertical",
    "5566-24A_2x12_P4.20mm_Vertical",

    # Horizontal variants (A1 variant)
    "5569-02A1_2x01_P4.20mm_Horizontal",
    "5569-04A1_2x02_P4.20mm_Horizontal",
    "5569-06A1_2x03_P4.20mm_Horizontal",
    "5569-08A1_2x04_P4.20mm_Horizontal",
    "5569-10A1_2x05_P4.20mm_Horizontal",
    "5569-12A1_2x06_P4.20mm_Horizontal",
    "5569-14A1_2x07_P4.20mm_Horizontal",
    "5569-16A1_2x08_P4.20mm_Horizontal",
    "5569-18A1_2x09_P4.20mm_Horizontal",
    "5569-20A1_2x10_P4.20mm_Horizontal",
    "5569-22A1_2x11_P4.20mm_Horizontal",
    "5569-24A1_2x12_P4.20mm_Horizontal",
)

# -----------------------------------------------------------------------------
# Component parameters
# -----------------------------------------------------------------------------

variant = config("variant", Variant, convert = Variant)
properties = config("properties", dict, optional = True)

# -----------------------------------------------------------------------------
# Helper functions
# -----------------------------------------------------------------------------

def PinCount(variant: Variant) -> int:
    # Extract pin count from variant string - all Mini-Fit Jr are 2-row
    s = str(variant)

    # Look for 2xNN pattern
    idx = s.find("2x")
    if idx != -1:
        start = idx + 2
        end = start
        for i in range(start, len(s)):
            if not s[i].isdigit():
                break
            end = i + 1
        return int(s[start:end]) * 2  # Multiply by 2 for double row

    error("Cannot determine pin count from variant: " + str(variant))

# -----------------------------------------------------------------------------
# IO ports (up to 24 pins for 2x12)
# -----------------------------------------------------------------------------

pins = {}
for pin in range(1, PinCount(variant) + 1):
    pins["Pin_{}".format(pin)] = io("Pin_{}".format(pin), Net)

# -----------------------------------------------------------------------------
# Helper functions
# -----------------------------------------------------------------------------

def _footprint(variant: Variant):
    # Map variants to their corresponding footprints
    footprint_map = {
        # Vertical variants
        Variant("5566-02A_2x01_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-02A_2x01_P4.20mm_Vertical.kicad_mod",
        Variant("5566-04A_2x02_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-04A_2x02_P4.20mm_Vertical.kicad_mod",
        Variant("5566-06A_2x03_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-06A_2x03_P4.20mm_Vertical.kicad_mod",
        Variant("5566-08A_2x04_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-08A_2x04_P4.20mm_Vertical.kicad_mod",
        Variant("5566-10A_2x05_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-10A_2x05_P4.20mm_Vertical.kicad_mod",
        Variant("5566-12A_2x06_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-12A_2x06_P4.20mm_Vertical.kicad_mod",
        Variant("5566-14A_2x07_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-14A_2x07_P4.20mm_Vertical.kicad_mod",
        Variant("5566-16A_2x08_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-16A_2x08_P4.20mm_Vertical.kicad_mod",
        Variant("5566-18A_2x09_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-18A_2x09_P4.20mm_Vertical.kicad_mod",
        Variant("5566-20A_2x10_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-20A_2x10_P4.20mm_Vertical.kicad_mod",
        Variant("5566-22A_2x11_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-22A_2x11_P4.20mm_Vertical.kicad_mod",
        Variant("5566-24A_2x12_P4.20mm_Vertical"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5566-24A_2x12_P4.20mm_Vertical.kicad_mod",

        # Horizontal variants
        Variant("5569-02A1_2x01_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-02A1_2x01_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-04A1_2x02_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-04A1_2x02_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-06A1_2x03_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-06A1_2x03_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-08A1_2x04_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-08A1_2x04_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-10A1_2x05_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-10A1_2x05_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-12A1_2x06_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-12A1_2x06_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-14A1_2x07_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-14A1_2x07_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-16A1_2x08_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-16A1_2x08_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-18A1_2x09_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-18A1_2x09_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-20A1_2x10_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-20A1_2x10_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-22A1_2x11_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-22A1_2x11_P4.20mm_Horizontal.kicad_mod",
        Variant("5569-24A1_2x12_P4.20mm_Horizontal"): "@kicad-footprints/Connector_Molex.pretty/Molex_Mini-Fit_Jr_5569-24A1_2x12_P4.20mm_Horizontal.kicad_mod",
    }

    if variant in footprint_map:
        return footprint_map[variant]
    else:
        error("No footprint found for variant: " + str(variant))

def _symbol(variant: Variant):
    """Get the appropriate symbol based on pin count."""
    pin_count = PinCount(variant)

    # All Mini-Fit Jr are double row
    rows = pin_count // 2
    row_str = str(rows) if rows >= 10 else "0" + str(rows)
    orientation = "_Top_Bottom" if pin_count > 2 else ""
    return "@kicad-symbols/Connector_Generic.kicad_sym:Conn_02x" + row_str + orientation

def _mpn(variant: Variant) -> str:
    return variant.value.split("_")[0]

# -----------------------------------------------------------------------------
# Component definition
# -----------------------------------------------------------------------------

Component(
    name = "MMFJ",
    type = "molex_mini_fit_jr",
    symbol = Symbol(_symbol(variant)),
    footprint = File(_footprint(variant)),
    prefix = "J",
    pins = pins,
    properties = Properties(
        properties,
        {
            "value": _mpn(variant),
            "mpn": _mpn(variant),
        },
    ),
)
